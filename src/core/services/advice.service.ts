import { Injectable } from '@angular/core';

export type AdviceCategory = 'creativity' | 'calm' | 'activity' | 'learning';
export type TimeOfDay = 'morning' | 'day' | 'evening' | 'night';

export interface Advice {
  id: number;
  text: string;
  category: AdviceCategory;
  mood: string;
  timeOfDay?: TimeOfDay[];
}

/**
 * @description
 * Сервис для получения советов из локального, заранее заготовленного списка.
 * Предоставляет "офлайн AI", который подбирает советы на основе контекста.
 * 
 * @todo
 * - Расширить базу советов.
 * - Добавить фильтрацию по настроению (mood).
 * - Реализовать систему "совет дня", чтобы не повторяться.
 */
@Injectable({
  providedIn: 'root'
})
export class AdviceService {

  private advices: Advice[] = [
    { id: 1, text: 'Попробуй нарисовать свой завтрак. Неважно, как получится, главное — уделить внимание цветам и формам.', category: 'creativity', mood: 'creativity', timeOfDay: ['morning'] },
    { id: 2, text: 'Включи музыку без слов и просто посмотри в окно 5 минут. Позволь мыслям течь свободно.', category: 'calm', mood: 'calm', timeOfDay: ['day', 'evening'] },
    { id: 3, text: 'Сделай небольшую 10-минутную прогулку. Постарайся заметить 3 вещи, которые раньше не замечал(а).', category: 'activity', mood: 'activity', timeOfDay: ['morning', 'day'] },
    { id: 4, text: 'Прочитай одну статью на Википедии о чем-то совершенно случайном. Новые знания вдохновляют!', category: 'learning', mood: 'learning', timeOfDay: ['day', 'evening'] },
    { id: 5, text: 'Завари свой любимый чай, укутайся в плед и перечитай несколько страниц любимой книги.', category: 'calm', mood: 'calm', timeOfDay: ['evening', 'night'] },
    { id: 6, text: 'Напиши три вещи, за которые ты благодарен(на) сегодня. Это простое упражнение меняет взгляд на мир.', category: 'calm', mood: 'calm', timeOfDay: ['evening', 'night'] },
    { id: 7, text: 'Попробуй приготовить что-то простое, но новое. Например, какао с щепоткой корицы и перца.', category: 'creativity', mood: 'creativity', timeOfDay: ['evening'] },
    { id: 8, text: 'Послушай один эпизод интересного подкаста. Можно совместить с домашними делами.', category: 'learning', mood: 'learning', timeOfDay: ['day'] },
    { id: 9, text: 'Сделай легкую растяжку. Твое тело скажет тебе спасибо.', category: 'activity', mood: 'activity', timeOfDay: ['morning', 'evening'] },
    { id: 10, text: 'Разбери одну полку в шкафу или ящик стола. Маленький порядок снаружи создает порядок внутри.', category: 'activity', mood: 'activity', timeOfDay: ['day'] },
  ];

  // 101 уникальный совет для психолога. Циклическая выдача без повторов до исчерпания.
  private psychologyAdvices: string[] = [
    'Развивайте навыки активного слушания: отражайте чувства клиента, а не только факты.',
    'Задавайте открытые вопросы, чтобы углубить понимание переживаний клиента.',
    'Поддерживайте безопасное пространство: валидируйте эмоции, избегайте оценочных суждений.',
    'Следите за своим контрпереносом: отмечайте внутренние реакции и при необходимости выносите их на супервизию.',
    'Формулируйте цели совместно с клиентом: измеримые, достижимые и значимые.',
    'Отслеживайте динамику: фиксируйте микросдвиги в состоянии клиента между сессиями.',
    'Развивайте гибкость подходов: сочетайте техники из разных школ, когда это уместно.',
    'Регулярно проверяйте гипотезы: не привязывайтесь к первому объяснению.',
    'Используйте техники заземления при сильной тревоге: дыхание, ориентирование, телесная чувствительность.',
    'Опирайтесь на сильные стороны клиента и прошлый опыт успешного совладания.',
    'Поддерживайте прозрачность рамок: время, оплата, границы контакта, политика отмен.',
    'Применяйте шкалиро��ание (0–10), чтобы отслеживать интенсивность эмоций и прогресс.',
    'Не спешите «чинить»: дайте месту истории клиента проявиться полностью.',
    'Наблюдайте за несоответствиями между вербализацией и невербаликой.',
    'Проясняйте запрос на каждом этапе: проблема, цель, критерии успеха.',
    'Используйте метафоры, если это помогает клиенту осмыслить опыт.',
    'Разграничивайте ответственность: ваша — за процесс, клиента — за выбор и действие.',
    'Поддерживайте ритм сессии: фазы контакта, углубления, интеграции и завершения.',
    'Периодически резюмируйте: «Я слышу, что…» для сверки понимания.',
    'Уточняйте, какие стратегии уже пробовал клиент и что помогало частично.',
    'Включайте элементы психообразования, когда это уменьшает стыд и тревогу.',
    'Будьте внимательны к травматическому опыту: темп, триггеры, границы, ресурсирование.',
    'Помогайте развивать толерантность к аффекту: короткие дозированные соприкосновения с эмоциями.',
    'Фокусируйтесь на «здесь‑и‑сейчас»: динамика отношений терапевт–клиент как источник инсайтов.',
    'Используйте дневники мыслей/эмоций/поведения для домашней работы.',
    'Проверяйте мотивацию к изменениям по модели стадий готовности.',
    'Различайте первичные и вторичные эмоции; работайте с первичными.',
    'Отмечайте «защитные» стратегии клиента с уважением к их функции.',
    'Развивайте самосострадание клиента: нормализация уязвимости и ошибок.',
    'Применяйте техники когнитивной реструктуризации к дезадаптивным убеждениям.',
    'Работайте с телесными сигналами: напряжение, дыхание, поза, микродвижения.',
    'Учитывайте культурный и семейный контекст — нормы, роли, ожидания.',
    'Поддерживайте агентность клиента: маленькие выполнимые шаги между сессиями.',
    'Выделяйте ресурсы: люди, места, занятия, которые восстанавливают.',
    'Внимательно относитесь к языку: избегайте патологизирующих ярлыков.',
    'Строьте гипотезы системно: индивидуальный, межличностный и институциональный уровни.',
    'Помогайте дифференцировать потребности и желания.',
    'Оценивайте риски (суицидальные мысли и пр.) и имейте план действий.',
    'Развивайте навыки эмоциональной регуляции: дыхание, пауза, переориентация внимания.',
    'Используйте временную перспективу: «Если через год всё станет лучше, что изменится?»',
    'Уважайте молчание: оно может быть глубоким материалом.',
    'Помогайте находить альтернативные объяснения привычным историям.',
    'Проверяйте «правила» клиента: «должен», «обязан», «нельзя».',
    'Выявляйте циклы поддержания проблемы и точки вмешательства.',
    'Выделяйте ценности клиента и выравнивайте цели с ними.',
    'Формируйте навыки границ: «да/нет», просьбы, отказы.',
    'Практикуйте рефрейминг: меняйте угол зрения на ситуацию.',
    'Помогайте интегрировать опыт через нарратив: прошлое–настоящее–будущее.',
    'Согласовывайте ожидания от терапии и критерии завершения.',
    'Регулярно делайте паузы для самоотслеживания состояния клиента.',
    'Используйте визуальные якоря: карты, схемы, шкалы.',
    'Работайте с «внутренним критиком»: выявление голоса, спор, альтернативные реплики.',
    'Поддерживайте осознанность: короткие практики присутствия.',
    'Развивайте толерантность к неопределённости через микроэкспозиции.',
    'Фиксируйте успехи: дневник достижений и стараний, а не только результатов.',
    'Освещайте скрытую цену симптома и возможные выигрыши от изменений.',
    'Помогайте распознавать триггеры и ранние признаки перегруза.',
    'Уточняйте границы компетенции и перенаправляйте при необходимости.',
    'Настраивайте интенсивность терапии под ресурс клиента.',
    'Работайте с ценностью отдыха и восстановительных практик.',
    'Разграничивайте чувства и действия: эмоции допустимы, поведение — выбор.',
    'Отмечайте моменты несовпадения запроса и реальной нужды.',
    'Фокусируйтесь на «малых шагах» для поддержания мотивации.',
    'Регулярно проводите самоаудит: этика, границы, выгорание.',
    'Ищите супервизию для сложных случаев и слепых зон.',
    'Поддерживайте профессиональное развитие: чтение, семинары, интервизии.',
    'Следите за гигиеной сочувствия: распределяйте эмоциональные вложения.',
    'Развивайте навык «замедления» перед импульсивной интервенцией.',
    'Проясняйте вторичные выгоды симптома без обесценивания.',
    'Не спешите диагностировать — сначала поймите историю.',
    'Используйте «колесо баланса» для оценки сфер жи��ни.',
    'Фокусируйте внимание на процессах, а не ярлыках.',
    'Выявляйте паттерны в отношениях клиента (повторяющиеся роли).',
    'Отделяйте факты от интерпретаций; учите клиента делать то же.',
    'Работайте с «внутренними частями личности» (parts work), когда уместно.',
    'Используйте шкалу заботы о себе: сон, питание, движение, отношения, смысл.',
    'Проверяйте влияние социальных сетей и информационной диеты.',
    'Обсуждайте устойчивые ритуалы поддержки между сессиями.',
    'Развивайте у клиента наблюдателя: замечать мысли/эмоции без слияния.',
    'Поддерживайте юмор, когда он не защитный, а восстановительный.',
    'Уважайте сопротивление как способ самосохранения.',
    'Иногда «меньше — лучше»: одна точная интервенция ценнее пяти.',
    'Соотносите технику с фазой процесса (стабилизация/проработка/интеграция).',
    'Отмечайте и признавайте амбивалентность — это нормально.',
    'Встраивайте навыки саморегуляции в повседневную рутину.',
    'Используйте «если бы…» сценарии для расширения поведенческого репертуара.',
    'Не забывайте про тело: соматика — важный канал доступа к опыту.',
    'Поддерживайте экологичную коммуникацию: «я‑сообщения».',
    'Развивайте терпимость к медленному прогрессу — нелинейность процесса.',
    'Помогайте оплакивать утраты: время, отношения, возможности.',
    'Сохраняйте любопытство и не знайте «лучше клиента» — он эксперт по себе.',
    'Регулярно проверяйте, что работает, а что нет, и адаптируйте план.',
    'Завершайте сессии интеграцией и конкретным фокусом на неделю.',
    'Заботьтесь о себе: режим, границы, отдых — фундамент качества помощи.',
    'Помните об этике: конфиденциальность, уважение, информированность.',
    'Поддерживайте надежду — реалистичную, опирающуюся на процесс и усилия.',
    'Празднуйте маленькие победы вместе с клиентом — это укрепляет альянс.',
    'Смотрите на рецидивы как на часть обучения, а не поражение.',
    'Уважайте уникальность пути клиента и ритм его изменений.',
    'Сохраняйте человеческое присутствие — теплоту, эмпатию и уважение.'
  ];

  private readonly psychIndexKey = 'katya-pocket-psych-advices-index';

  constructor() {}

  /**
   * Возвращает следующий совет для психолога без повторов до исчерпания, затем по кругу.
   */
  getNextPsychologyAdvice(): string {
    const total = this.psychologyAdvices.length;
    if (!total) return 'Советы временно недоступны.';
    let idx = 0;
    try {
      const raw = localStorage.getItem(this.psychIndexKey);
      idx = raw ? Math.max(0, Math.min(total - 1, parseInt(raw))) : 0;
    } catch {}
    const text = this.psychologyAdvices[idx];
    const next = (idx + 1) % total;
    try { localStorage.setItem(this.psychIndexKey, String(next)); } catch {}
    return text;
  }

  /**
   * @description
   * Возвращает случайный совет, опционально фильтруя по времени суток.
   * @returns Объект совета.
   */
  getRandomAdvice(): Advice {
    const currentTimeOfDay = this.getCurrentTimeOfDay();
    
    // Пытаемся найти совет, подходящий по времени суток
    const filteredAdvices = this.advices.filter(advice => 
      !advice.timeOfDay || advice.timeOfDay.includes(currentTimeOfDay)
    );

    const advicesToChooseFrom = filteredAdvices.length > 0 ? filteredAdvices : this.advices;
    
    const randomIndex = Math.floor(Math.random() * advicesToChooseFrom.length);
    return advicesToChooseFrom[randomIndex];
  }

  /**
   * @description
   * Генерирует ответ, похожий на AI, на основе предустановленных запросов.
   * @param prompt - Запрос пользователя.
   * @returns Отформатированная строка с советом/идеями.
   */
  getPredefinedResponse(prompt: string): string {
    if (prompt.includes('грустно')) {
      return `Мне жаль, что тебе грустно. Иногда помогает просто укутаться в плед и посмотреть что-то доброе. Вот несколько идей:
      <ul><li><strong>"Унесённые призраками"</strong> — для волшебной атмосферы.</li><li><strong>"Паддингтон 2"</strong> — самый уютный фильм на свете.</li><li>Короткие мультики Pixar — они всегда поднимают настроение!</li></ul>`;
    } 
    if (prompt.includes('творчества')) {
      return `Конечно! Вот три идеи, чтобы разбудить вдохновение:
      <ul><li><strong>Нарисуй свой сон.</strong> Неважно, как получится, главное — процесс.</li><li><strong>Напиши короткое письмо.</strong> Себе в будущем или любимому персонажу.</li><li><strong>Сделай коллаж</strong> из старых журналов или просто красивых бумажек.</li></ul>`;
    }
    
    // "Не знаю, что сделать сегодня" или любой другой запрос
    const advice1 = this.getRandomAdvice();
    let advice2 = this.getRandomAdvice();
    while(advice2.id === advice1.id) {
        advice2 = this.getRandomAdvice();
    }
    let advice3 = this.getRandomAdvice();
    while(advice3.id === advice1.id || advice3.id === advice2.id) {
        advice3 = this.getRandomAdvice();
    }
    
    return `Хм, прекрасный вопрос! Сегодня можно попробовать что-то новое. Например:
    <ul>
    <li>${advice1.text}</li>
    <li>${advice2.text}</li>
    <li>${advice3.text}</li>
    </ul>`;
  }

  /**
   * @description
   * Возвращает эмоционально‑поддерживающий ответ на основе ключевых слов
   * в запросе. Поддерживаются простые эмоции: грусть, радость, злость,
   * усталость, скука, тревога. Если эмоция не распознана, возвращается
   * случайный совет из списка.
   * @param prompt - пользовательский запрос
   * @returns строка с поддержкой
   */
  getEmotionResponse(prompt: string): string {
    const lower = prompt.toLowerCase();
    if (lower.includes('грустно') || lower.includes('печаль') || lower.includes('тоска')) {
      return `Мне жаль, что ты чувствуешь грусть. Позволь себе почувствовать это, а потом попробуй:
      <ul><li>Сделать короткую прогулку на свежем воздухе.</li><li>Послушать любимую песню.</li><li>Написать письмо себе в будущее, где ты говоришь, как всё будет хорошо.</li></ul>`;
    }
    if (lower.includes('радостно') || lower.includes('счастлив') || lower.includes('улыбаюсь')) {
      return `Отлично! Радость заразительна. Попробуй поделиться ею с кем‑то близким или записать, что именно тебя радует, чтобы закрепить позитивный настрой.`;
    }
    if (lower.includes('злой') || lower.includes('злость') || lower.includes('сердит')) {
      return `Ситуация может быть напряжённой, но помни: дыхательные упражнения помогают успокоиться. Попробуй 4‑7‑8: вдох 4 секунды, задержка 7, выдох 8.
      <ul><li>Сделай небольшую растяжку.</li><li>Поставь таймер на 5 минут и послушай спокойную музыку.</li></ul>`;
    }
    if (lower.includes('устал') || lower.includes('мёрз') || lower.includes('слаб')) {
      return `Тело и ум нуждаются в отдыхе. Попробуй медитацию на 5 минут, затем лёгкую растяжку. Если есть возможность, сделай короткий сон или просто посиди в тишине.
      <ul><li>Сделай 10‑минутную прогулку.</li><li>Проверь, не перегружен ли твой рабочий стол.</li></ul>`;
    }
    if (lower.includes('скучно') || lower.includes('неинтересно')) {
      return `Скука — сигнал к новому вызову. Вот несколько идей:
      <ul><li>Собери пазл из 500 кусочков.</li><li>Проведи эксперимент: попробуй приготовить блюдо, которое никогда не делал.</li><li>Запиши короткую историю о себе, как будто ты герой фильма.</li></ul>`;
    }
    if (lower.includes('тревога') || lower.includes('стресс') || lower.includes('напряжён')) {
      return `Стресс может быть управляемым. Попробуй:
      <ul><li>Сделать дыхательную практику 4‑7‑8.</li><li>Поставить таймер на 15 минут и посвятить его чтению чего‑то нового.</li><li>Сделать небольшую растяжку, чтобы снять напряжение в мышцах.</li></ul>`;
    }
    // fallback
    return this.getRandomAdvice().text;
  }

  /**
   * @description
   * Определяет текущее время суток.
   * @returns 'morning', 'day', 'evening', или 'night'.
   */
  private getCurrentTimeOfDay(): TimeOfDay {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'morning';
    if (hour >= 12 && hour < 18) return 'day';
    if (hour >= 18 && hour < 23) return 'evening';
    return 'night';
  }
}
